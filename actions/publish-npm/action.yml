name: Publish to NPM
description: Publish the package to the NPM registry using npm Trusted Publishers
inputs:
  version:
    description: Semver bump or explicit version to release.
    required: true
  tag:
    description: npm dist-tag to publish to.
    required: true
  working-directory:
    description: Directory that contains the package.json file.
    required: false
    default: "."
  node-version:
    description: Node.js version to use for publishing.
    required: false
    default: "20"
  registry-url:
    description: Registry URL used for npm publish.
    required: false
    default: "https://registry.npmjs.org"
  scope:
    description: npm scope configured for trusted publisher auth. Leave blank for unscoped packages.
    required: false
    default: "@stencil"
  install-command:
    description: Command used to install dependencies. Leave blank to skip.
    required: false
    default: "npm ci"
  build-command:
    description: Command used to build the package. Leave blank to skip.
    required: false
    default: "npm run build"

runs:
  using: "composite"
  steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: ğŸ“ Log Inputs
      shell: bash
      run: |
        echo "Version: ${{ inputs.version }}"
        echo "Tag: ${{ inputs.tag }}"

    - name: ğŸŸ¢ Configure Node for Publish (Unscoped)
      if: ${{ inputs.scope == '' }}
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: ${{ inputs.registry-url }}

    - name: ğŸŸ¢ Configure Node for Publish (Scoped)
      if: ${{ inputs.scope != '' }}
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: ${{ inputs.registry-url }}
        scope: ${{ inputs.scope }}

    - name: ğŸ”„ Ensure Latest npm
      shell: bash
      run: npm install -g npm@latest

    - name: ğŸ“¦ Install Dependencies
      if: ${{ inputs.install-command != '' }}
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.install-command }}

    - name: ğŸ› ï¸ Build Package
      if: ${{ inputs.build-command != '' }}
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.build-command }}

    - name: ğŸ·ï¸ Set Version
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: npm version --no-git-tag-version --allow-same-version ${{ inputs.version }}

    - name: ğŸš€ Publish to npm
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: npm publish --tag ${{ inputs.tag }} --provenance
